DROP TABLE "FORFAIT" CASCADE CONSTRAINTS;
DROP TABLE "GA" CASCADE CONSTRAINTS;
DROP TABLE "PN" CASCADE CONSTRAINTS;
DROP TABLE "PALIER" CASCADE CONSTRAINTS;
DROP TABLE "EVALUATION" CASCADE CONSTRAINTS;
DROP TABLE "PRESTATAIRE" CASCADE CONSTRAINTS;
DROP TABLE "REGION" CASCADE CONSTRAINTS;
DROP TABLE "INCIDENT" CASCADE CONSTRAINTS;

	
	CREATE TABLE "REGION" 
   (	"REGION_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"NOM" VARCHAR2(50 CHAR), 
	"LONGITUDE" NUMBER, 
	"LATITUDE" NUMBER, 
	"NM_MISSION" NUMBER, 
	"REGION" VARCHAR2(50 CHAR), 
	 CONSTRAINT "REGION_PK" PRIMARY KEY ("REGION_ID")
  USING INDEX  ENABLE
   ) ;

CREATE TABLE "EVALUATION" 
   (	"EVALUATION_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
    "SCORE" FLOAT(126), 
	"PRESTATAIRE_ID" NUMBER NOT NULL ENABLE, 
	"DATE_EVALUATION" DATE, 
	"TAUX_RESPET_DELAIS" NUMBER, 
	"NBR_MISSION_RETARD" NUMBER, 
	"TAUX_INCIDENT" NUMBER, 
	"TAUX_MISSIONNEMENT" NUMBER, 
	"TAUX_RESPECT_COUTMOY" NUMBER, 
	"TAUX_DE_RECTIFATION" NUMBER,  
	 CONSTRAINT "EVALUATION_PK" PRIMARY KEY ("EVALUATION_ID")
  USING INDEX  ENABLE
   ) ;
 CREATE TABLE "PRESTATAIRE" 
   (	"NOM" VARCHAR2(50 CHAR), 
	"PRENOM" VARCHAR2(50 CHAR), 
	"DATE_INSCRIPTION" DATE, 
	"REGION_ID" NUMBER, 
	"PRESTATAIRE_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"EVALUATION_ID" NUMBER, 
	"LONGITUDE" NUMBER, 
	"LATITUDE" NUMBER, 
	"NBR_MISSION" NUMBER, 
	"MATRICULE" VARCHAR2(1000), 
	 CONSTRAINT "PRESTATAIRE_PK" PRIMARY KEY ("PRESTATAIRE_ID")
  USING INDEX  ENABLE
   ) ;

  ALTER TABLE "PRESTATAIRE" ADD CONSTRAINT "PRESTATAIRE_REGION" FOREIGN KEY ("REGION_ID")
	  REFERENCES "REGION" ("REGION_ID") ENABLE;
  ALTER TABLE "PRESTATAIRE" ADD CONSTRAINT "PRESTATAIRE_EVALUATION_FK" FOREIGN KEY ("EVALUATION_ID")
	  REFERENCES "EVALUATION" ("EVALUATION_ID") ENABLE;
  ALTER TABLE "EVALUATION" ADD CONSTRAINT "EVALUATION_PRESTATAIRE_FK" FOREIGN KEY ("PRESTATAIRE_ID")
	  REFERENCES "PRESTATAIRE" ("PRESTATAIRE_ID") ENABLE;

 CREATE TABLE "FORFAIT" 
   (	"FORFAIT_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"STATUS" NUMBER(1,0), 
	"FRAUDE" NUMBER(1,0), 
	"COUT_EXPERT" NUMBER, 
	"DATE_PRISE_PHOTO" DATE, 
    "DATE_VALIDATION_DEVIS" DATE, 
	"DATE_PUB_DEVIS" DATE, 
	"DATE_PUBLICATION_RAPPORT" DATE, 
	"REGION_ID" NUMBER, 
	"PESTATAIRE_MATRICULE" VARCHAR2(100 CHAR), 
	"DATE_MISSIONNEMENT" DATE, 
	"DATE_CONFIRMATION_RDV" DATE, 
	"PRESTATAIRE_ID" NUMBER, 
	 CONSTRAINT "MISSION_PK" PRIMARY KEY ("FORFAIT_ID")
  USING INDEX  ENABLE
   ) ;

  ALTER TABLE "FORFAIT" ADD CONSTRAINT "REGION_FK" FOREIGN KEY ("REGION_ID")
	  REFERENCES "REGION" ("REGION_ID") ENABLE;
  
  ALTER TABLE "FORFAIT" ADD CONSTRAINT "FORFAIT_PRESTATAIRE_FK" FOREIGN KEY ("PRESTATAIRE_ID")
	  REFERENCES "PRESTATAIRE" ("PRESTATAIRE_ID") ENABLE;

  CREATE TABLE "GA" 
   (	"GA_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"STATUS" NUMBER(1,0), 
	"FRAUDE" NUMBER(1,0), 
	"COUT_EXPERT" NUMBER, 
	"DATE_PRISE_PHOTO" DATE, 
	"DATE_PUBLICATION_RAPPORT" DATE, 
	"REGION_ID" NUMBER, 
	"MATRICULE" VARCHAR2(100 CHAR), 
	"DATE_PUB_FACTURE" DATE, 
	"DATE_VALIDATION_DEVIS" DATE, 
	"DATE_PUB_DEVIS" DATE, 
	"DATE_IMMOBILISATION" DATE, 
	"PRESTATAIRE_ID" NUMBER, 
	 CONSTRAINT "GA_PK" PRIMARY KEY ("GA_ID")
  USING INDEX  ENABLE
   ) ;

  ALTER TABLE "GA" ADD CONSTRAINT "REGION_GA_FK" FOREIGN KEY ("REGION_ID")
	  REFERENCES "REGION" ("REGION_ID") ENABLE;

  ALTER TABLE "GA" ADD CONSTRAINT "GA_PRESTATAIRE_FK" FOREIGN KEY ("PRESTATAIRE_ID")
	  REFERENCES "PRESTATAIRE" ("PRESTATAIRE_ID") ENABLE;


  CREATE TABLE "INCIDENT" 
   (	"INCIDENT_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"GRAVITE" VARCHAR2(10 CHAR), 
	"DESCRIPTION" VARCHAR2(1000 CHAR), 
	"TEXT" VARCHAR2(1000 CHAR), 
    DATE_INCIDENT   DATE DEFAULT SYSDATE,
	"PRESTATAIRE_ID" NUMBER NOT NULL ENABLE, 
	 CONSTRAINT "INCIDENT_PK" PRIMARY KEY ("INCIDENT_ID")
  USING INDEX  ENABLE
   ) ;

  ALTER TABLE "INCIDENT" ADD CONSTRAINT "INCIDENT_PRESTATAIRE_FK" FOREIGN KEY ("PRESTATAIRE_ID")
	  REFERENCES "PRESTATAIRE" ("PRESTATAIRE_ID") ENABLE;



  CREATE TABLE "PALIER" 
   (	"PALIER_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"NOM" VARCHAR2(50 CHAR), 
	"MAX" NUMBER, 
	"MIN" NUMBER, 
	"COUT_MOYEN" FLOAT(126), 
	 CONSTRAINT "PALIER_PK" PRIMARY KEY ("PALIER_ID")
  USING INDEX  ENABLE
   ) ;


  CREATE TABLE "PN" 
   (	"PN_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"STATUS" NUMBER(1,0), 
	"FRAUDE" NUMBER(1,0), 
	"COUT_EXPERT" NUMBER, 
	"DATE_PRISE_PHOTO" DATE, 
	"DATE_PUBLICATION_RAPPORT" DATE, 
	"REGION_ID" NUMBER, 
	"MATRICULE" VARCHAR2(100 CHAR), 
	"DATE_MISSIONNEMENT" DATE, 
	"DATE_CONFIRMATIONRDV" DATE, 
	"DATE_VALIDATION_DEVIS" DATE, 
	"DATE_PUB_DEVIS" DATE, 
	"PALIER_ID" NUMBER NOT NULL ENABLE, 
	"PRESTATAIRE_ID" NUMBER, 
	 CONSTRAINT "PN_PK" PRIMARY KEY ("PN_ID")
  USING INDEX  ENABLE
   ) ;

  ALTER TABLE "PN" ADD CONSTRAINT "REGION_PN_FK" FOREIGN KEY ("REGION_ID")
	  REFERENCES "REGION" ("REGION_ID") ENABLE;
  ALTER TABLE "PN" ADD CONSTRAINT "PALIER_FK" FOREIGN KEY ("PALIER_ID")
	  REFERENCES "PALIER" ("PALIER_ID") ENABLE;
 
  ALTER TABLE "PN" ADD CONSTRAINT "PN_PRESTATAIRE_FK" FOREIGN KEY ("PRESTATAIRE_ID")
	  REFERENCES "PRESTATAIRE" ("PRESTATAIRE_ID") ENABLE;



----------------mission view
CREATE OR REPLACE FORCE EDITIONABLE VIEW MISSION (
  MISSION_ID,
  MISSION_TYPE,
  UNIQUE_MISSION_ID,
  PRESTATAIRE_ID,
  REGION_ID,
  STATUS,
  FRAUDE,
  COUT_EXPERT,
  DEBUT_INTERVENTION,
  FIN_INTERVENTION,
  DEBUT_TRAITEMENT,
  FIN_TRAITEMENT,
  DEBUT_RAPPORT,
  FIN_RAPPORT
) AS

-- Forfait
SELECT  
  f.FORFAIT_ID              AS MISSION_ID, 
  'FORFAIT'                 AS MISSION_TYPE, 
  'FORFAIT' || '_' || f.FORFAIT_ID AS UNIQUE_MISSION_ID,
  f.PRESTATAIRE_ID, 
  r.REGION_ID, 
  f.STATUS, 
  f.FRAUDE, 
  f.COUT_EXPERT, 
  f.DATE_PRISE_PHOTO        AS DEBUT_INTERVENTION, 
  f.DATE_MISSIONNEMENT      AS FIN_INTERVENTION, 
  f.DATE_PUB_DEVIS          AS DEBUT_TRAITEMENT, 
  f.DATE_VALIDATION_DEVIS   AS FIN_TRAITEMENT, 
  f.DATE_PRISE_PHOTO        AS DEBUT_RAPPORT, 
  f.DATE_PUBLICATION_RAPPORT AS FIN_RAPPORT
FROM FORFAIT f 
JOIN REGION r ON f.REGION_ID = r.REGION_ID

UNION ALL

-- Garage
SELECT  
  g.GA_ID                   AS MISSION_ID, 
  'GARAGE'                  AS MISSION_TYPE,
  'GARAGE' || '_' || g.GA_ID     AS UNIQUE_MISSION_ID, 
  g.PRESTATAIRE_ID, 
  r.REGION_ID, 
  g.STATUS, 
  g.FRAUDE, 
  g.COUT_EXPERT, 
  g.DATE_PRISE_PHOTO        AS DEBUT_INTERVENTION, 
  g.DATE_IMMOBILISATION     AS FIN_INTERVENTION, 
  g.DATE_PUB_DEVIS          AS DEBUT_TRAITEMENT, 
  g.DATE_VALIDATION_DEVIS   AS FIN_TRAITEMENT, 
  g.DATE_PUB_DEVIS          AS DEBUT_RAPPORT, 
  g.DATE_PUBLICATION_RAPPORT AS FIN_RAPPORT
FROM GA g 
JOIN REGION r ON g.REGION_ID = r.REGION_ID

UNION ALL

-- Proc√©dure Normale
SELECT  
  p.PN_ID                   AS MISSION_ID, 
  'PROCEDURE NORMALE'       AS MISSION_TYPE, 
  'PROCEDURE NORMALE'   || '_' ||   p.PN_ID   AS UNIQUE_MISSION_ID,
  p.PRESTATAIRE_ID, 
  r.REGION_ID, 
  p.STATUS, 
  p.FRAUDE, 
  p.COUT_EXPERT, 
  p.DATE_PRISE_PHOTO            AS DEBUT_INTERVENTION, 
  p.DATE_MISSIONNEMENT          AS FIN_INTERVENTION, 
  p.DATE_PUB_DEVIS              AS DEBUT_TRAITEMENT, 
  p.DATE_VALIDATION_DEVIS       AS FIN_TRAITEMENT, 
  p.DATE_PUB_DEVIS              AS DEBUT_RAPPORT, 
  p.DATE_PUBLICATION_RAPPORT    AS FIN_RAPPORT
FROM PN p 
JOIN REGION r ON p.REGION_ID = r.REGION_ID
WHERE p.PALIER_ID = 1;

  